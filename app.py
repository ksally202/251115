import streamlit as st
import numpy as np
import pandas as pd
from datetime import datetime, timedelta

st.set_page_config(
    page_title="ALL DAY Stress Out",
    page_icon="ğŸŒ¿",
    layout="centered"
)

st.title("ğŸŒ¿ ALL DAY Stress Out")
st.write("AI ê¸°ë°˜ ê°ì •Â·ìŠ¤íŠ¸ë ˆìŠ¤Â·ìˆ˜ë©´ì„ í•œ ë²ˆì— ê´€ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.")

# ---------------------------------------------------
# ğŸ˜Š ì˜¤ëŠ˜ì˜ ê¸°ë¶„ ì„ íƒ â†’ session_state ì €ì¥
# ---------------------------------------------------
st.markdown("## ğŸ˜Š ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”")

mood = st.segmented_control(
    "ì˜¤ëŠ˜ ê¸°ë¶„",
    ["ğŸ˜Š í–‰ë³µ", "ğŸ™‚ ë³´í†µ", "ğŸ˜¥ ìŠ¤íŠ¸ë ˆìŠ¤", "ğŸ˜­ ë§¤ìš° ìŠ¤íŠ¸ë ˆìŠ¤"]
)

# ğŸ”¥ ì´ˆê¸°ê°’(None)ì¼ ë•Œ ê¸°ë³¸ê°’ ì„¤ì •
if mood is None:
    mood = "ğŸ™‚ ë³´í†µ"

# ì €ì¥
st.session_state["selected_mood"] = mood

st.write(f"**ì˜¤ëŠ˜ì˜ ê¸°ë¶„:** {mood}")

# ---------------------------------------------------
# ê¸°ë¶„ â†’ ëª¨ë¸ ì˜í–¥ê°’
# ---------------------------------------------------
mood_score_map = {
    "ğŸ˜Š í–‰ë³µ": -8,
    "ğŸ™‚ ë³´í†µ": 0,
    "ğŸ˜¥ ìŠ¤íŠ¸ë ˆìŠ¤": +7,
    "ğŸ˜­ ë§¤ìš° ìŠ¤íŠ¸ë ˆìŠ¤": +15
}

mood_effect = mood_score_map[mood]

# ---------------------------------------------------
# ê°€ìƒ 60ì¼ ìŠ¤íŠ¸ë ˆìŠ¤Â·ìˆ˜ë©´ ë°ì´í„° ìƒì„±
# ---------------------------------------------------
today = datetime.today()
dates = [today - timedelta(days=i) for i in range(60)]
dates = sorted(dates)

rng = np.random.default_rng(42)
stress_vals = np.clip(rng.normal(70, 10, 60), 20, 100)
sleep_vals = np.clip(rng.normal(7, 1.2, 60), 4, 10)

df = pd.DataFrame({
    "ë‚ ì§œ": dates,
    "ìŠ¤íŠ¸ë ˆìŠ¤": stress_vals,
    "ìˆ˜ë©´": sleep_vals
})

today_sleep = df.iloc[-1]["ìˆ˜ë©´"]

# ---------------------------------------------------
# AI ì˜ˆì¸¡ í•¨ìˆ˜
# ---------------------------------------------------
def ai_predict(stress_series, sleep_today, mood_effect):
    # ìµœê·¼ ë³€í™”ì˜ EMA
    ema_pred = stress_series.ewm(span=5).mean().iloc[-1]

    # ìˆ˜ë©´ ì˜í–¥
    sleep_effect = 0
    if sleep_today < 5:
        sleep_effect += 10
    elif sleep_today < 6:
        sleep_effect += 5

    # ìµœì¢… ê²°í•©
    final_pred = ema_pred + sleep_effect + mood_effect
    return float(np.clip(final_pred, 0, 100))

# ---------------------------------------------------
# ğŸ“Š ì˜¤ëŠ˜ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ = AI ëª¨ë¸ ê³„ì‚°
# ---------------------------------------------------
today_stress = ai_predict(
    df["ìŠ¤íŠ¸ë ˆìŠ¤"],
    today_sleep,
    mood_effect
)

st.markdown("## ğŸ“Š ì˜¤ëŠ˜ì˜ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ (AI ê¸°ë°˜)")
st.metric("ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜", f"{today_stress:.1f} / 100")

with st.expander("ğŸ”® ë”ë³´ê¸° (ì˜ˆì¸¡ì€ ì™¼ìª½ ë©”ë‰´ì˜ ğŸ“ˆ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”!)"):
    st.write("ì˜ˆì¸¡ ê¸°ëŠ¥ì€ ì‚¬ì´ë“œë°” ë©”ë‰´ì˜ **ğŸ“ˆ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ ì˜ˆì¸¡** í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.")

st.markdown("---")

# ---------------------------------------------------
# ğŸµ ì¶”ì²œ ë©”ì‹œì§€
# ---------------------------------------------------
st.markdown("## ğŸµ ì˜¤ëŠ˜ì˜ ì¶”ì²œ")
st.info("ì¹´í˜ì¸ ì„­ì·¨ê°€ ë§ì•˜ë‹¤ë©´ ë”°ëœ»í•œ í—ˆë¸Œí‹°ë¥¼ ë§ˆì‹œê³  ê°€ë³ê²Œ ì‚°ì±…í•´ë³´ì„¸ìš” ğŸ˜Š")

st.video("https://www.youtube.com/watch?v=UBMk30rjy0o")

st.markdown("---")

# ---------------------------------------------------
# ğŸ”’ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥
# ---------------------------------------------------
st.markdown("## ğŸ”’ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥: ìˆ˜ë©´ íŒ¨í„´ ë¶„ì„")
premium = st.checkbox("ğŸ”“ í”„ë¦¬ë¯¸ì—„ ì ê¸ˆ í•´ì œ")

if not premium:
    st.warning("ì´ ê¸°ëŠ¥ì€ í”„ë¦¬ë¯¸ì—„ ì´ìš©ìì—ê²Œë§Œ ì œê³µë©ë‹ˆë‹¤.")
else:
    sleep_hours = np.random.randint(4, 9, size=7)
    df_sleep = pd.DataFrame({
        "Day": ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
        "Sleep": sleep_hours
    })
    st.write("### ğŸ’¤ 1ì£¼ì¼ ìˆ˜ë©´ íŒ¨í„´")
    st.line_chart(df_sleep, x="Day", y="Sleep")

st.markdown("---")


# ---------------------------------------------------
# Q&A: ìˆ˜ë©´ì‹œê°„ì€ ì–´ë–»ê²Œ ì¸¡ì •í•˜ë‚˜ìš”?
# ---------------------------------------------------
with st.container():
    st.markdown('<div class="mobile-card">', unsafe_allow_html=True)
    st.subheader("â“ ìˆ˜ë©´ ì‹œê°„ì€ ì–´ë–»ê²Œ ì¸¡ì •í•˜ë‚˜ìš”?")

    with st.expander("ë‹µë³€ ë³´ê¸°"):
        st.markdown("""
**Q. ìˆ˜ë©´ì‹œê°„ì€ ì–´ë–»ê²Œ ê³„ì‚°ë˜ë‚˜ìš”?**  
A. ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ìŠ¤ë§ˆíŠ¸í°Â·ìŠ¤ë§ˆíŠ¸ì›Œì¹˜ì˜ **ì›€ì§ì„ ì„¼ì„œ, ì‹¬ë°•ìˆ˜, í™”ë©´ ì‚¬ìš© íŒ¨í„´**ì„ ê¸°ë°˜ìœ¼ë¡œ  
ì ë“  ì‹œì ê³¼ ê¹¨ì–´ë‚œ ì‹œì ì„ ì¶”ì •í•©ë‹ˆë‹¤.

**Q. ì™„ë²½í•˜ê²Œ ì •í™•í•œê°€ìš”?**  
A. 100% ì •í™•í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.  
ë…ì„œ ì¤‘ í™”ë©´ì´ êº¼ì ¸ ìˆì„ ë•Œì²˜ëŸ¼, ì‹¤ì œë¡œëŠ” ì•ˆ ì¤ì§€ë§Œ ê¸°ê¸°ê°€ ìˆ˜ë©´ìœ¼ë¡œ íŒë‹¨í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.  

**Q. ë” ì •í™•í•œ ë°©ë²•ì€ ìˆë‚˜ìš”?**  
A. ë„¤. ì›¨ì–´ëŸ¬ë¸”(ìŠ¤ë§ˆíŠ¸ì›Œì¹˜)ì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´  
ì‹¬ë°•ìˆ˜Â·ì›€ì§ì„ ë°ì´í„°ë¥¼ í•¨ê»˜ ë¶„ì„í•˜ë¯€ë¡œ  
**ì–•ì€ ì /ê¹Šì€ ì ê¹Œì§€ ì¸¡ì •í•  ìˆ˜ ìˆì–´ í›¨ì”¬ ì •í™•**í•´ì§‘ë‹ˆë‹¤.
""")

st.caption("Â© 2025 ALL DAY Stress Out")
